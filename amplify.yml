version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci --cache .npm --prefer-offline
    build:
      commands:
        # Create .env.production file for SSR Lambda access
        - 'echo "Creating environment file for branch $AWS_BRANCH..."'

        # Debug environment variables before writing
        - 'echo "Checking if variables exist..."'
        - 'echo "CLERK_SECRET_KEY exists - $(if [ -n \"$CLERK_SECRET_KEY\" ]; then echo YES; else echo NO; fi)"'
        - 'echo "NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY exists - $(if [ -n \"$NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY\" ]; then echo YES; else echo NO; fi)"'
        - 'echo "DATABASE_URL exists - $(if [ -n \"$DATABASE_URL\" ]; then echo YES; else echo NO; fi)"'

        # Clear any existing .env.production file
        - rm -f .env.production

        # Write all environment variables to .env.production
        - 'echo "# Auto-generated environment file for AWS Amplify build" > .env.production'
        - 'echo "# Branch: $AWS_BRANCH" >> .env.production'
        - 'echo "# Build Time: $(date)" >> .env.production'
        - 'echo "# Environment: $(if [ \"$AWS_BRANCH\" = \"main\" ]; then echo production; else echo staging; fi)" >> .env.production'

        # Clerk variables (critical for middleware)
        - 'echo "CLERK_SECRET_KEY=$CLERK_SECRET_KEY" >> .env.production'
        - 'echo "NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=$NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY" >> .env.production'
        - 'echo "NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in" >> .env.production'
        - 'echo "NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up" >> .env.production'
        - 'echo "NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/admin" >> .env.production'
        - 'echo "NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/admin" >> .env.production'

        # Database variables
        - 'echo "DATABASE_URL=$DATABASE_URL" >> .env.production'

        # Site URL (different for prod vs staging)
        - |
          if [ "$AWS_BRANCH" = "main" ]; then
            echo "NEXT_PUBLIC_SITE_URL=https://subwaysounds.net" >> .env.production
          else
            echo "NEXT_PUBLIC_SITE_URL=https://staging.subwaysounds.net" >> .env.production
          fi

        # GTM
        - 'echo "NEXT_PUBLIC_GTM_ID=$NEXT_PUBLIC_GTM_ID" >> .env.production'

        # Cloudflare R2 (Image Storage)
        - 'echo "R2_ACCOUNT_ID=$R2_ACCOUNT_ID" >> .env.production'
        - 'echo "R2_ACCESS_KEY_ID=$R2_ACCESS_KEY_ID" >> .env.production'
        - 'echo "R2_SECRET_ACCESS_KEY=$R2_SECRET_ACCESS_KEY" >> .env.production'
        - 'echo "R2_BUCKET_NAME=subway-sounds-images" >> .env.production'
        - 'echo "R2_PUBLIC_URL=https://pub-e840d0273cf34b648e38bac3383b2fa1.r2.dev" >> .env.production'

        # Debug - show what was written
        - 'echo "=== .env.production contents ==="'
        - cat .env.production
        - 'echo "=== END ==="'

        # Verify critical variables
        - 'grep "CLERK_SECRET_KEY" .env.production || echo "❌ CLERK_SECRET_KEY not found!"'
        - 'grep "DATABASE_URL" .env.production || echo "❌ DATABASE_URL not found!"'

        # Generate Prisma client
        - npx prisma generate

        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
      - .npm/**/*
