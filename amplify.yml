version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci --cache .npm --prefer-offline
    build:
      commands:
        # Create .env.production file for SSR Lambda access
        - 'echo "Creating environment file for branch $AWS_BRANCH..."'

        # Debug environment variables before writing
        - 'echo "Checking if variables exist..."'
        - 'echo "CLERK_SECRET_KEY exists - $(if [ -n \"$CLERK_SECRET_KEY\" ]; then echo YES; else echo NO; fi)"'
        - 'echo "NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY exists - $(if [ -n \"$NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY\" ]; then echo YES; else echo NO; fi)"'
        - 'echo "DATABASE_URL exists - $(if [ -n \"$DATABASE_URL\" ]; then echo YES; else echo NO; fi)"'

        # Clear any existing .env.production file
        - rm -f .env.production

        # Write all environment variables to .env.production
        - 'echo "# Auto-generated environment file for AWS Amplify build" > .env.production'
        - 'echo "# Branch: $AWS_BRANCH" >> .env.production'
        - 'echo "# Build Time: $(date)" >> .env.production'

        # Clerk variables (critical for middleware)
        - 'echo "CLERK_SECRET_KEY=$CLERK_SECRET_KEY" >> .env.production'
        - 'echo "NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=$NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY" >> .env.production'
        - 'echo "NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in" >> .env.production'
        - 'echo "NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up" >> .env.production'

        # Database variables
        - 'echo "DATABASE_URL=$DATABASE_URL" >> .env.production'

        # Site URL
        - 'echo "NEXT_PUBLIC_SITE_URL=$NEXT_PUBLIC_SITE_URL" >> .env.production'

        # GTM
        - 'echo "NEXT_PUBLIC_GTM_ID=$NEXT_PUBLIC_GTM_ID" >> .env.production'

        # Debug - show what was written
        - 'echo "=== .env.production contents ==="'
        - cat .env.production
        - 'echo "=== END ==="'

        # Verify critical variables
        - 'grep "CLERK_SECRET_KEY" .env.production || echo "❌ CLERK_SECRET_KEY not found!"'
        - 'grep "DATABASE_URL" .env.production || echo "❌ DATABASE_URL not found!"'

        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
      - .npm/**/*
